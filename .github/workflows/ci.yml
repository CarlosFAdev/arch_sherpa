name: CI

on:
  push:
    branches: [main, master]
  pull_request:

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
      - name: Install dependencies
        run: dart pub get
      - name: Format check
        run: dart format --output=none --set-exit-if-changed .
      - name: Analyze
        run: dart analyze
      - name: Test
        run: dart test
      - name: Doctor strict fixture
        run: dart run bin/arch_sherpa.dart --project-root test/fixtures/ci_strict_project doctor --strict
      - name: Install pana
        run: dart pub global activate pana
      - name: Run pana (JSON)
        run: dart pub global run pana --no-warning --json . > pana_report.json
      - name: Enforce pana max points
        run: dart run tool/pana_gate.dart pana_report.json
